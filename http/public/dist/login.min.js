/* MailJS - v0.1.0 - 05-12-2015 Â© AtlasDev*/!function(factory){if("function"==typeof define&&define.amd)define(factory);else if("object"==typeof exports)module.exports=factory();else{var _OldCookies=window.Cookies,api=window.Cookies=factory();api.noConflict=function(){return window.Cookies=_OldCookies,api}}}(function(){function extend(){for(var i=0,result={};i<arguments.length;i++){var attributes=arguments[i];for(var key in attributes)result[key]=attributes[key]}return result}function init(converter){function api(key,value,attributes){var result;if(arguments.length>1){if(attributes=extend({path:"/"},api.defaults,attributes),"number"==typeof attributes.expires){var expires=new Date;expires.setMilliseconds(expires.getMilliseconds()+864e5*attributes.expires),attributes.expires=expires}try{result=JSON.stringify(value),/^[\{\[]/.test(result)&&(value=result)}catch(e){}return value=encodeURIComponent(String(value)),value=value.replace(/%(23|24|26|2B|3A|3C|3E|3D|2F|3F|40|5B|5D|5E|60|7B|7D|7C)/g,decodeURIComponent),key=encodeURIComponent(String(key)),key=key.replace(/%(23|24|26|2B|5E|60|7C)/g,decodeURIComponent),key=key.replace(/[\(\)]/g,escape),document.cookie=[key,"=",value,attributes.expires&&"; expires="+attributes.expires.toUTCString(),attributes.path&&"; path="+attributes.path,attributes.domain&&"; domain="+attributes.domain,attributes.secure?"; secure":""].join("")}key||(result={});for(var cookies=document.cookie?document.cookie.split("; "):[],rdecode=/(%[0-9A-Z]{2})+/g,i=0;i<cookies.length;i++){var parts=cookies[i].split("="),name=parts[0].replace(rdecode,decodeURIComponent),cookie=parts.slice(1).join("=");'"'===cookie.charAt(0)&&(cookie=cookie.slice(1,-1));try{if(cookie=converter&&converter(cookie,name)||cookie.replace(rdecode,decodeURIComponent),this.json)try{cookie=JSON.parse(cookie)}catch(e){}if(key===name){result=cookie;break}key||(result[name]=cookie)}catch(e){}}return result}return api.get=api.set=api,api.getJSON=function(){return api.apply({json:!0},[].slice.call(arguments))},api.defaults={},api.remove=function(key,attributes){api(key,"",extend(attributes,{expires:-1}))},api.withConverter=init,api}return init()});var token,user={},domains=[],canCreate,group={};$(document).ready(function(){if(get.msg&&"true"!=get.info&&showLoginError(get.msg),"true"==get.info&&get.msg&&showInfo(get.msg),"true"==get.setup&&Cookies.get("MailJS")){var request=$.ajax({type:"GET",url:"/api/v1/user/current",dataType:"json",cache:!1,headers:{"x-token":Cookies.get("MailJS")}});request.done(function(data){user=data.user,showSetup()}),request.fail(function(data){Cookies.remove("MailJS"),showLogin()})}else Cookies.get("MailJS")&&window.location.replace("app.html")}),$(".logout").click(function(){var request=$.ajax({type:"DELETE",url:"/api/v1/login",dataType:"json",cache:!1});request.done(function(data){Cookies.remove("MailJS"),showLogin()}),request.fail(function(data){Cookies.remove("MailJS"),showLogin()})}),$("#login").submit(function(event){event.preventDefault();var request=$.ajax({type:"POST",url:"/api/v1/login",dataType:"json",cache:!1,data:{username:$("#username").val(),password:$("#password").val()}});request.done(function(data){1==data.needTFA?(token=data.token,setName(data.user.firstName+" "+data.user.lastName),showTFA()):0==data.user.mailboxes.length?(user=data.user,showSetup()):window.location.replace("app.html")}),request.fail(function(data){showLoginError(401==data.status?"Username/password incorrect!":400==data.status?"Username/password not filled in!":JSON.parse(data.responseText).error.message)})}),$("#2fa").submit(function(event){event.preventDefault();var request=$.ajax({type:"PATCH",url:"/api/v1/login",dataType:"json",cache:!1,headers:{"x-token":token},data:{code:$("#code").val()}});request.done(function(data){window.location.replace("app.html")}),request.fail(function(data){401==data.status&&showLogin();var text=JSON.parse(data.responseText);"EDONE"==text.error.name?window.location.replace("app.html"):show2faError("EINVALID"==text.error.name?"Code invalid!":text.error.message)})}),$("#setupCreate").submit(function(event){event.preventDefault();var local=$("#localCreate").val(),domain=$("#domainCreate").val(),title=$("#titleCreate").val();if(""==local)return showSetupError("Please fill in a local part.");if(""==title)return showSetupError("Please fill in a mailbox title.");if(""==domain)return showSetupError("Please select a domain.");var request=$.ajax({type:"POST",url:"/api/v1/mailbox",dataType:"json",cache:!1,headers:{"x-token":Cookies.get("MailJS")},data:{local:local,domain:domain,title:title}});request.done(function(data){window.location.replace("app.html")}),request.fail(function(data){showSetupError(JSON.parse(data.responseText).error.message)})}),$("#setupTransfer").submit(function(event){event.preventDefault();var code=$("#transferCode").val(),request=$.ajax({type:"PATCH",url:"/api/v1/mailbox",dataType:"json",cache:!1,headers:{"x-token":Cookies.get("MailJS")},data:{transfercode:code}});request.done(function(data){window.location.replace("app.html")}),request.fail(function(data){showSetupError(JSON.parse(data.responseText).error.message)})});var showTFA=function(){$("#2fa-box").show(),$("#login-box").hide(),$("#setup-box").hide()},showLogin=function(){$("#2fa-box").hide(),$("#login-box").show(),$("#setup-box").hide()},showSetup=function(){setName(user.firstName+" "+user.lastName);var request=$.ajax({type:"GET",url:"/api/v1/group/"+user.group,dataType:"json",cache:!1,headers:{"x-token":Cookies.get("MailJS")}});request.done(function(data){if(group=data.group,-1!=group.permissions.indexOf("mailbox.create")){var request=$.ajax({type:"GET",url:"/api/v1/domain",dataType:"json",cache:!1,headers:{"x-token":Cookies.get("MailJS")}});request.done(function(data){$.each(data.domains,function(key,value){$("#domainCreate").append($("<option></option>").attr("value",value._id).text(value.domain))}),$("#setupCreate").show()}),request.fail(function(data){user={},showLogin()})}}),request.fail(function(data){user={},showLogin()}),$("#2fa-box").hide(),$("#login-box").hide(),$("#setup-box").show()},setName=function(name){$("#name").text(name)},showLoginError=function(msg){$("#loginErrorMsg").text(msg),$("#loginError").removeClass("hidden")},show2faError=function(msg){$("#TFAerrorMsg").text(msg),$("#TFAerror").removeClass("hidden")},showSetupError=function(msg){$("#setupErrorMsg").text(msg),$("#setupError").removeClass("hidden")},showInfo=function(msg){$("#infoMsg").text(msg),$("#info").removeClass("hidden")},get=function(a){if(""==a)return{};for(var b={},i=0;i<a.length;++i){var p=a[i].split("=",2);1==p.length?b[p[0]]="":b[p[0]]=decodeURIComponent(p[1].replace(/\+/g," "))}return b}(window.location.search.substr(1).split("&"));